<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="jakarta.faces.html" xmlns:p="http://primefaces.org/ui"
    xmlns:f="jakarta.faces.core" xmlns:ui="jakarta.faces.facelets" template="/WEB-INF/template.xhtml">

    <ui:define name="content">
        <h1 style="margin-bottom: 5px;"><i class="pi pi-shopping-cart" style="color: #3b82f6;"></i> Mis Pedidos</h1>
        <p style="color: #666; margin-top: 0;">Crea y gestiona tus requerimientos de materiales</p>

        <h:form id="formReq">
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 25px; margin-top: 20px;">
                <div>
                    <p:panel
                        header="#{requerimientoBean.editando ? (requerimientoBean.requerimiento.estado eq 'OBSERVADO' ? 'Corregir Requerimiento Observado' : 'Editar Requerimiento') : 'Nuevo Requerimiento'}"
                        styleClass="shadow-2" style="height: 100%;">

                        <!-- Alerta de Observación del Jefe -->
                        <p:outputPanel
                            rendered="#{requerimientoBean.editando and requerimientoBean.requerimiento.estado eq 'OBSERVADO'}"
                            style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="display: flex; align-items: flex-start; gap: 10px;">
                                <i class="pi pi-exclamation-triangle" style="color: #d97706; font-size: 1.5rem;"></i>
                                <div>
                                    <strong style="color: #92400e;">Este requerimiento fue observado por el
                                        Jefe</strong>
                                    <p style="margin: 5px 0 0 0; color: #78350f; white-space: pre-wrap;">
                                        #{requerimientoBean.requerimiento.observacion}</p>
                                </div>
                            </div>
                        </p:outputPanel>
                        <p:panelGrid columns="2" layout="grid" style="width: 100%;" contentStyle="padding: 8px 5px;"
                            columnClasses="label-col, input-col">

                            <p:outputLabel value="Solicitante:" />
                            <h:outputText value="#{loginBean.usuarioLogueado.nombreCompleto}"
                                style="font-weight: bold; color: #2563eb;" />

                            <p:outputLabel value="Fecha:" />
                            <h:outputText value="#{requerimientoBean.requerimiento.fechaSolicitud}">
                                <f:convertDateTime pattern="dd/MM/yyyy" type="localDate" />
                            </h:outputText>

                            <p:outputLabel value="Área de Negocio:" for="area" />
                            <p:selectOneMenu id="area" value="#{requerimientoBean.requerimiento.areaNegocio}"
                                converter="omnifaces.SelectItemsConverter" required="true" style="width: 100%;">
                                <f:selectItem itemLabel="-- Seleccionar --" itemValue="" />
                                <f:selectItems value="#{requerimientoBean.listaAreasNegocio}" var="a"
                                    itemLabel="#{a.prefijo} - #{a.nombre}" itemValue="#{a}" />
                                <p:ajax listener="#{requerimientoBean.onAreaChange}" update="jefe" />
                            </p:selectOneMenu>

                            <p:outputLabel value="Jefe Aprobador:" for="jefe" />
                            <p:selectOneMenu id="jefe" value="#{requerimientoBean.requerimiento.jefeAprobador}"
                                converter="omnifaces.SelectItemsConverter" required="true" style="width: 100%;">
                                <f:selectItem itemLabel="-- Seleccionar --" itemValue="" />
                                <f:selectItems value="#{requerimientoBean.listaJefes}" var="j"
                                    itemLabel="#{j.nombreCompleto}" itemValue="#{j}" />
                            </p:selectOneMenu>

                            <p:outputLabel value="Proyecto:" for="proy" />
                            <p:selectOneMenu id="proy" value="#{requerimientoBean.requerimiento.proyecto}"
                                converter="omnifaces.SelectItemsConverter" required="true" style="width: 100%;">
                                <f:selectItem itemLabel="-- Seleccionar --" itemValue="" />
                                <f:selectItems value="#{requerimientoBean.listaProyectos}" var="p"
                                    itemLabel="#{p.codigo} - #{p.nombre}" itemValue="#{p}" />
                            </p:selectOneMenu>

                            <p:outputLabel value="Etapa:" for="etapa" />
                            <p:selectOneMenu id="etapa" value="#{requerimientoBean.requerimiento.etapa}" required="true"
                                style="width: 100%;">
                                <f:selectItem itemLabel="Etapa 1" itemValue="1" />
                                <f:selectItem itemLabel="Etapa 2" itemValue="2" />
                                <f:selectItem itemLabel="Etapa 3" itemValue="3" />
                            </p:selectOneMenu>

                            <p:outputLabel value="Centro de Costo:" for="cc" />
                            <p:selectOneMenu id="cc" value="#{requerimientoBean.requerimiento.centroCosto}"
                                converter="omnifaces.SelectItemsConverter" required="true" style="width: 100%;">
                                <f:selectItem itemLabel="-- Seleccionar --" itemValue="" />
                                <f:selectItems value="#{requerimientoBean.listaCentrosCosto}" var="c"
                                    itemLabel="#{c.codigo} - #{c.nombre}" itemValue="#{c}" />
                            </p:selectOneMenu>
                        </p:panelGrid>

                        <!-- Campo de Observaciones -->
                        <div style="margin-top: 15px;">
                            <label style="font-weight: 500; display: block; margin-bottom: 5px;">
                                Observaciones Adicionales:
                            </label>
                            <p:inputTextarea id="obs" value="#{requerimientoBean.requerimiento.observacion}" rows="3"
                                style="width: 100%;"
                                placeholder="Ingrese cualquier observación o detalle adicional sobre este requerimiento..." />
                        </div>
                    </p:panel>
                </div>

                <!-- PANEL DERECHO: Items del Requerimiento -->
                <div>
                    <p:panel header="Items del Requerimiento" styleClass="shadow-2">
                        <!-- Formulario para agregar item -->
                        <div
                            style="display: grid; grid-template-columns: 3fr 1fr auto; gap: 10px; margin-bottom: 15px; align-items: end;">
                            <div>
                                <label style="font-weight: 500; display: block; margin-bottom: 5px;">Material</label>
                                <p:selectOneMenu value="#{requerimientoBean.idMaterialSeleccionado}" filter="true"
                                    filterMatchMode="contains" style="width: 100%;">
                                    <f:selectItem itemLabel="-- Buscar material --" itemValue="" />
                                    <f:selectItems value="#{requerimientoBean.listaMateriales}" var="m"
                                        itemLabel="#{m.nombre} (#{m.unidad.abreviatura})" itemValue="#{m.id}" />
                                </p:selectOneMenu>
                            </div>
                            <div>
                                <label style="font-weight: 500; display: block; margin-bottom: 5px;">Cantidad</label>
                                <p:inputNumber value="#{requerimientoBean.detalle.cantidadSolicitada}" decimalPlaces="2"
                                    minValue="0.01" style="width: 100%;" />
                            </div>
                            <p:commandButton value="Agregar" icon="pi pi-plus"
                                actionListener="#{requerimientoBean.agregarDetalle}" update="tablaItems"
                                styleClass="ui-button-success" style="height: 40px;" />
                        </div>

                        <!-- Tabla de items agregados -->
                        <p:dataTable id="tablaItems" value="#{requerimientoBean.detalles}" var="d"
                            emptyMessage="No hay items agregados" stripedRows="true" size="small">
                            <p:column headerText="#" width="40">
                                <h:outputText value="#{d_rowIndex + 1}" />
                            </p:column>
                            <p:column headerText="Material">
                                <h:outputText value="#{d.material.nombre}" />
                            </p:column>
                            <p:column headerText="Unidad" width="80">
                                <h:outputText value="#{d.material.unidad.abreviatura}" />
                            </p:column>
                            <p:column headerText="Cantidad" width="100" style="text-align: right;">
                                <h:outputText value="#{d.cantidadSolicitada}">
                                    <f:convertNumber minFractionDigits="2" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="" width="50">
                                <p:commandButton icon="pi pi-trash" styleClass="ui-button-danger ui-button-sm"
                                    actionListener="#{requerimientoBean.eliminarDetalle(d)}" update="tablaItems" />
                            </p:column>
                        </p:dataTable>

                        <div style="text-align: right; margin-top: 15px;">
                            <p:commandButton value="Limpiar" icon="pi pi-refresh"
                                actionListener="#{requerimientoBean.nuevoRequerimiento}" update=":formReq"
                                styleClass="ui-button-secondary" style="margin-right: 10px;" />

                            <!-- Botón Guardar para nuevo o edición normal -->
                            <p:commandButton
                                value="#{requerimientoBean.editando ? 'Actualizar' : 'Guardar Requerimiento'}"
                                icon="pi pi-save" actionListener="#{requerimientoBean.guardar}" update=":formReq :msgs"
                                styleClass="ui-button-success"
                                rendered="#{not requerimientoBean.editando or requerimientoBean.requerimiento.estado ne 'OBSERVADO'}" />

                            <!-- Botón Reenviar para requerimientos observados -->
                            <p:commandButton value="Reenviar al Jefe" icon="pi pi-send"
                                actionListener="#{requerimientoBean.reenviarAlJefe}" update=":formReq :msgs"
                                styleClass="ui-button-warning"
                                rendered="#{requerimientoBean.editando and requerimientoBean.requerimiento.estado eq 'OBSERVADO'}" />
                        </div>
                    </p:panel>
                </div>
            </div>

            <!-- TABLA DE MIS REQUERIMIENTOS -->
            <p:panel header="Mis Requerimientos Recientes" style="margin-top: 25px;" styleClass="shadow-2">
                <p:dataTable value="#{requerimientoBean.requerimientos}" var="r" paginator="true" rows="10"
                    stripedRows="true" emptyMessage="No tienes requerimientos registrados">

                    <p:column headerText="ID" width="60">
                        <h:outputText value="#{r.id}" />
                    </p:column>
                    <p:column headerText="Fecha" width="100">
                        <h:outputText value="#{r.fechaSolicitud}">
                            <f:convertDateTime pattern="dd/MM/yyyy" type="localDate" />
                        </h:outputText>
                    </p:column>
                    <p:column headerText="Área">
                        <h:outputText value="#{r.areaNegocio.prefijo}" rendered="#{r.areaNegocio ne null}" />
                    </p:column>
                    <p:column headerText="Proyecto">
                        <h:outputText value="#{r.proyecto.nombre}" />
                    </p:column>
                    <p:column headerText="C.Costo" width="80">
                        <h:outputText value="#{r.centroCosto.codigo}" />
                    </p:column>
                    <p:column headerText="Etapa" width="60" style="text-align: center;">
                        <p:badge value="#{r.etapa}" severity="info" />
                    </p:column>
                    <p:column headerText="Items" width="60" style="text-align: center;">
                        <p:badge value="#{r.detalles.size()}" />
                    </p:column>
                    <p:column headerText="Estado" width="120">
                        <p:badge value="#{r.estado.label}"
                            severity="#{r.estado eq 'APROBADO' ? 'success' : (r.estado eq 'RECHAZADO' ? 'danger' : (r.estado eq 'OBSERVADO' ? 'warning' : 'info'))}" />
                    </p:column>
                    <p:column headerText="Acciones" width="180" style="text-align: center;">
                        <!-- Ver observación del jefe -->
                        <p:commandButton icon="pi pi-eye" styleClass="ui-button-warning ui-button-sm"
                            title="Ver Observación" rendered="#{r.estado eq 'OBSERVADO'}"
                            onclick="PF('dlgObs#{r.id}').show(); return false;" />

                        <!-- Editar -->
                        <p:commandButton icon="pi pi-pencil" styleClass="ui-button-sm"
                            actionListener="#{requerimientoBean.seleccionarParaEditar(r)}" update=":formReq"
                            title="Editar" rendered="#{requerimientoBean.puedeEditar(r)}" style="margin-left: 5px;" />

                        <!-- Eliminar -->
                        <p:commandButton icon="pi pi-trash" styleClass="ui-button-danger ui-button-sm"
                            actionListener="#{requerimientoBean.eliminar(r)}" update=":formReq :msgs" title="Eliminar"
                            rendered="#{requerimientoBean.puedeEditar(r)}" style="margin-left: 5px;">
                            <p:confirm header="Confirmar" message="¿Eliminar este requerimiento?"
                                icon="pi pi-exclamation-triangle" />
                        </p:commandButton>

                        <!-- Mini diálogo de observación -->
                        <p:dialog widgetVar="dlgObs#{r.id}" header="Observación del Jefe" modal="true" width="400"
                            closable="true" rendered="#{r.estado eq 'OBSERVADO'}">
                            <div style="padding: 15px;">
                                <p style="white-space: pre-wrap; color: #666;">#{r.observacion}</p>
                            </div>
                        </p:dialog>
                    </p:column>
                </p:dataTable>
            </p:panel>

            <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                <p:commandButton value="Sí" type="button" styleClass="ui-confirmdialog-yes ui-button-danger"
                    icon="pi pi-check" />
                <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no" icon="pi pi-times" />
            </p:confirmDialog>
        </h:form>

        <style>
            .label-col {
                width: 35%;
                font-weight: 500;
            }

            .input-col {
                width: 65%;
            }

            .shadow-2 {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
        </style>
    </ui:define>
</ui:composition>
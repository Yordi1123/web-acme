<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="jakarta.faces.html" xmlns:p="http://primefaces.org/ui"
    xmlns:f="jakarta.faces.core" xmlns:ui="jakarta.faces.facelets" template="/WEB-INF/template.xhtml">

    <ui:define name="content">
        <h1 style="margin-bottom: 5px;">
            <i class="pi pi-inbox" style="color: #8b5cf6;"></i> Bandeja de Entrada - Compras
        </h1>
        <p style="color: #666; margin-top: 0;">
            Seleccione items de múltiples requerimientos para crear órdenes de compra agrupadas
        </p>

        <h:form id="formPool">
            <!-- Tabs para cambiar entre vistas -->
            <p:tabView id="tabView" activeIndex="#{poolComprasBean.vistaActiva eq 'items' ? 1 : 0}">

                <!-- TAB 1: Vista por Requerimientos -->
                <p:tab title="Por Requerimiento">
                    <p:dataTable id="tablaRequerimientos" value="#{poolComprasBean.requerimientosAprobados}" var="req"
                        rowKey="#{req.id}" paginator="true" rows="10" stripedRows="true"
                        emptyMessage="No hay requerimientos aprobados pendientes" style="margin-top: 15px;">

                        <f:facet name="header">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600;">
                                    <i class="pi pi-list"></i> Requerimientos Aprobados
                                    <p:badge value="#{poolComprasBean.requerimientosAprobados.size()}" severity="info"
                                        style="margin-left: 10px;" />
                                </span>
                                <p:commandButton icon="pi pi-refresh" title="Actualizar"
                                    action="#{poolComprasBean.cargarRequerimientosAprobados}"
                                    update="tablaRequerimientos" styleClass="ui-button-secondary ui-button-sm" />
                            </div>
                        </f:facet>

                        <p:column style="width: 40px; text-align: center;">
                            <p:rowToggler />
                        </p:column>

                        <p:column headerText="Código" style="width: 120px;">
                            <h:outputText value="#{req.codigoReq ne null ? req.codigoReq : 'REQ-'.concat(req.id)}"
                                style="font-weight: bold; color: #3b82f6;" />
                        </p:column>

                        <p:column headerText="Fecha" style="width: 100px;">
                            <h:outputText value="#{req.fechaSolicitud}">
                                <f:convertDateTime pattern="dd/MM/yyyy" type="localDate" />
                            </h:outputText>
                        </p:column>

                        <p:column headerText="Proyecto">
                            <h:outputText value="#{req.proyecto.nombre}" />
                        </p:column>

                        <p:column headerText="Solicitante">
                            <h:outputText value="#{req.usuarioSolicitante.nombreCompleto}" />
                        </p:column>

                        <p:column headerText="Items Pend." style="width: 100px; text-align: center;">
                            <p:badge value="#{poolComprasBean.contarItemsPendientes(req)}"
                                severity="#{poolComprasBean.contarItemsPendientes(req) gt 0 ? 'danger' : 'success'}" />
                        </p:column>

                        <p:column headerText="Acción" style="width: 80px; text-align: center;">
                            <p:commandButton icon="pi pi-shopping-cart" styleClass="ui-button-success ui-button-rounded"
                                title="Generar OC con todos los items de este requerimiento"
                                action="#{poolComprasBean.generarOrdenDesdeRequerimiento(req)}" />
                        </p:column>

                        <p:rowExpansion>
                            <div style="padding: 15px; background: #f8fafc;">
                                <p:dataTable value="#{req.detalles}" var="det" stripedRows="true" size="small">
                                    <p:column headerText="Material">
                                        <h:outputText value="#{det.material.nombre}" style="font-weight: 500;" />
                                    </p:column>
                                    <p:column headerText="Unidad" style="width: 80px;">
                                        <h:outputText value="#{det.material.unidad.abreviatura}" />
                                    </p:column>
                                    <p:column headerText="Solicitado" style="width: 100px; text-align: right;">
                                        <h:outputText value="#{det.cantidadSolicitada}">
                                            <f:convertNumber minFractionDigits="2" />
                                        </h:outputText>
                                    </p:column>
                                    <p:column headerText="Pendiente" style="width: 100px; text-align: right;">
                                        <h:outputText value="#{det.cantidadPendiente}"
                                            style="color: #{det.cantidadPendiente gt 0 ? '#dc2626' : '#22c55e'}; font-weight: bold;">
                                            <f:convertNumber minFractionDigits="2" />
                                        </h:outputText>
                                    </p:column>
                                </p:dataTable>
                            </div>
                        </p:rowExpansion>
                    </p:dataTable>
                </p:tab>

                <!-- TAB 2: Vista por Items (para selección múltiple) -->
                <p:tab title="Selección Múltiple">
                    <div
                        style="background: #dbeafe; border: 1px solid #3b82f6; border-radius: 8px; padding: 15px; margin: 15px 0;">
                        <i class="pi pi-info-circle" style="color: #1d4ed8;"></i>
                        <strong style="color: #1e40af;"> Modo Agrupado:</strong>
                        <span style="color: #1e3a8a;">Seleccione items de DIFERENTES requerimientos para crear UNA sola
                            orden de compra</span>
                    </div>

                    <p:dataTable id="tablaItems" value="#{poolComprasBean.itemsPendientes}" var="item"
                        selection="#{poolComprasBean.itemsSeleccionados}" rowKey="#{item.id}" paginator="true" rows="15"
                        stripedRows="true" emptyMessage="No hay items pendientes">

                        <f:facet name="header">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600;">
                                    <i class="pi pi-box"></i> Items Pendientes de Compra
                                    <p:badge value="#{poolComprasBean.itemsPendientes.size()}" severity="warning"
                                        style="margin-left: 10px;" />
                                </span>
                                <div style="display: flex; gap: 10px;">
                                    <p:commandButton icon="pi pi-refresh" title="Actualizar"
                                        action="#{poolComprasBean.cargarItemsPendientes}" update="tablaItems"
                                        styleClass="ui-button-secondary ui-button-sm" />
                                    <p:commandButton value="Generar OC con Seleccionados" icon="pi pi-shopping-cart"
                                        action="#{poolComprasBean.generarOrden}" styleClass="ui-button-success"
                                        disabled="#{empty poolComprasBean.itemsSeleccionados}" />
                                </div>
                            </div>
                        </f:facet>

                        <p:column selectionMode="multiple" style="width: 50px; text-align: center;" />

                        <p:column headerText="Req #" style="width: 70px;">
                            <h:outputText value="#{item.requerimiento.id}" style="font-weight: bold; color: #3b82f6;" />
                        </p:column>

                        <p:column headerText="Proyecto">
                            <h:outputText value="#{item.requerimiento.proyecto.nombre}" />
                        </p:column>

                        <p:column headerText="Material">
                            <h:outputText value="#{item.material.nombre}" style="font-weight: 500;" />
                        </p:column>

                        <p:column headerText="Grupo" style="width: 100px;">
                            <p:badge value="#{item.material.grupo.nombre}" severity="secondary" />
                        </p:column>

                        <p:column headerText="Unidad" style="width: 70px;">
                            <h:outputText value="#{item.material.unidad.abreviatura}" />
                        </p:column>

                        <p:column headerText="Solicitado" style="width: 90px; text-align: right;">
                            <h:outputText value="#{item.cantidadSolicitada}">
                                <f:convertNumber minFractionDigits="2" />
                            </h:outputText>
                        </p:column>

                        <p:column headerText="Pendiente" style="width: 90px; text-align: right;">
                            <h:outputText value="#{item.cantidadPendiente}" style="color: #dc2626; font-weight: bold;">
                                <f:convertNumber minFractionDigits="2" />
                            </h:outputText>
                        </p:column>

                        <f:facet name="footer">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">
                                <span style="color: #666;">
                                    <i class="pi pi-check-square"></i>
                                    Seleccionados: <strong>#{poolComprasBean.itemsSeleccionados.size()}</strong> items
                                </span>
                                <p:commandButton value="Generar Orden de Compra" icon="pi pi-shopping-cart"
                                    action="#{poolComprasBean.generarOrden}" styleClass="ui-button-success"
                                    disabled="#{empty poolComprasBean.itemsSeleccionados}" />
                            </div>
                        </f:facet>
                    </p:dataTable>
                </p:tab>
            </p:tabView>
        </h:form>

        <style>
            .shadow-2 {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
        </style>
    </ui:define>
</ui:composition>
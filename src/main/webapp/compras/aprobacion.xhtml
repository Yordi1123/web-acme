<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="jakarta.faces.html" xmlns:p="http://primefaces.org/ui"
    xmlns:f="jakarta.faces.core" xmlns:ui="jakarta.faces.facelets" template="/WEB-INF/template.xhtml">

    <ui:define name="content">
        <h1><i class="pi pi-check-circle" style="color: #22c55e;"></i> Bandeja de Aprobación</h1>
        <p style="color: #666;">Requerimientos pendientes de aprobación</p>

        <h:form id="formBandeja">
            <p:dataTable id="tablaPendientes" value="#{aprobacionBean.requerimientosPendientes}" var="r"
                paginator="true" rows="10" stripedRows="true" rowKey="#{r.id}"
                emptyMessage="No hay requerimientos pendientes de aprobación">

                <p:column headerText="ID" width="60" sortBy="#{r.id}">
                    <h:outputText value="#{r.id}" />
                </p:column>

                <p:column headerText="Fecha" sortBy="#{r.fechaSolicitud}">
                    <h:outputText value="#{r.fechaSolicitud}">
                        <f:convertDateTime pattern="dd/MM/yyyy" type="localDate" />
                    </h:outputText>
                </p:column>

                <p:column headerText="Solicitante">
                    <h:outputText value="#{r.usuarioSolicitante.nombreCompleto}" />
                </p:column>

                <p:column headerText="Proyecto">
                    <h:outputText value="#{r.proyecto.nombre}" />
                </p:column>

                <p:column headerText="C.Costo">
                    <h:outputText value="#{r.centroCosto.codigo} - #{r.centroCosto.nombre}" />
                </p:column>

                <p:column headerText="Items">
                    <p:badge value="#{r.detalles.size()}" severity="info" />
                </p:column>

                <p:column headerText="Acciones" style="text-align: center; width: 180px;">
                    <p:commandButton icon="pi pi-check" styleClass="rounded-button ui-button-success"
                        actionListener="#{aprobacionBean.aprobar(r)}" update="tablaPendientes :msgs" title="Aprobar" />

                    <p:commandButton icon="pi pi-eye" styleClass="rounded-button ui-button-warning"
                        oncomplete="PF('dlgObservar').show()" actionListener="#{aprobacionBean.seleccionar(r)}"
                        update=":formObservar" title="Observar" style="margin-left: 5px;" />

                    <p:commandButton icon="pi pi-times" styleClass="rounded-button ui-button-danger"
                        oncomplete="PF('dlgRechazar').show()" actionListener="#{aprobacionBean.seleccionar(r)}"
                        update=":formRechazar" title="Rechazar" style="margin-left: 5px;" />
                </p:column>

                <!-- Row Expansion: Ver detalle de items -->
                <p:rowExpansion>
                    <p:panelGrid columns="2" styleClass="ui-panelgrid-blank" style="width: 100%;">
                        <p:outputLabel value="Observación:" />
                        <h:outputText value="#{r.observacion}" style="font-style: italic;" />
                    </p:panelGrid>
                    <p:dataTable value="#{r.detalles}" var="d" style="margin-top: 10px;">
                        <p:column headerText="Material">
                            <h:outputText value="#{d.material.nombre}" />
                        </p:column>
                        <p:column headerText="Unidad">
                            <h:outputText value="#{d.material.unidad.abreviatura}" />
                        </p:column>
                        <p:column headerText="Cantidad Solicitada">
                            <h:outputText value="#{d.cantidadSolicitada}" />
                        </p:column>
                    </p:dataTable>
                </p:rowExpansion>
            </p:dataTable>

            <p:confirmDialog global="true">
                <p:commandButton value="Sí" type="button" styleClass="ui-confirmdialog-yes" icon="pi pi-check" />
                <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no ui-button-secondary"
                    icon="pi pi-times" />
            </p:confirmDialog>
        </h:form>

        <!-- Diálogo para Observar -->
        <p:dialog header="Observar Requerimiento" widgetVar="dlgObservar" modal="true" width="500">
            <h:form id="formObservar">
                <p:panelGrid columns="1" styleClass="ui-fluid">
                    <p:outputLabel value="Requerimiento ##{aprobacionBean.requerimientoSeleccionado.id}"
                        style="font-weight: bold;" />
                    <p:outputLabel value="Ingrese la observación para devolver al solicitante:" />
                    <p:inputTextarea value="#{aprobacionBean.observacionAprobador}" rows="4"
                        placeholder="Describa los cambios necesarios..." required="true" />
                </p:panelGrid>
                <f:facet name="footer">
                    <p:commandButton value="Enviar Observación" icon="pi pi-send"
                        actionListener="#{aprobacionBean.observar(aprobacionBean.requerimientoSeleccionado)}"
                        update=":formBandeja:tablaPendientes :msgs" oncomplete="PF('dlgObservar').hide()"
                        styleClass="ui-button-warning" />
                    <p:commandButton value="Cancelar" icon="pi pi-times" onclick="PF('dlgObservar').hide()"
                        type="button" styleClass="ui-button-secondary" style="margin-left: 10px;" />
                </f:facet>
            </h:form>
        </p:dialog>

        <!-- Diálogo para Rechazar con Observación -->
        <p:dialog header="Rechazar Requerimiento" widgetVar="dlgRechazar" modal="true" width="500">
            <h:form id="formRechazar">
                <div
                    style="background: #fee2e2; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #dc2626;">
                    <p style="margin: 0; color: #991b1b; font-weight: 500;">
                        <i class="pi pi-exclamation-triangle" style="margin-right: 8px;"></i>
                        Esta acción rechazará el requerimiento
                    </p>
                </div>
                <p:panelGrid columns="1" styleClass="ui-fluid">
                    <p:outputLabel value="Requerimiento ##{aprobacionBean.requerimientoSeleccionado.id}"
                        style="font-weight: bold;" />
                    <p:outputLabel value="Ingrese el motivo del rechazo (obligatorio):" />
                    <p:inputTextarea value="#{aprobacionBean.observacionAprobador}" rows="4"
                        placeholder="Explique por qué se rechaza este requerimiento..." required="true" />
                </p:panelGrid>
                <f:facet name="footer">
                    <p:commandButton value="Confirmar Rechazo" icon="pi pi-times"
                        actionListener="#{aprobacionBean.rechazarConObservacion(aprobacionBean.requerimientoSeleccionado)}"
                        update=":formBandeja:tablaPendientes :msgs" oncomplete="PF('dlgRechazar').hide()"
                        styleClass="ui-button-danger" />
                    <p:commandButton value="Cancelar" icon="pi pi-ban" onclick="PF('dlgRechazar').hide()" type="button"
                        styleClass="ui-button-secondary" style="margin-left: 10px;" />
                </f:facet>
            </h:form>
        </p:dialog>
    </ui:define>
</ui:composition>
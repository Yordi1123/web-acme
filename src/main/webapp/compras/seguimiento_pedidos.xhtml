<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="jakarta.faces.html" xmlns:p="http://primefaces.org/ui"
    xmlns:f="jakarta.faces.core" xmlns:ui="jakarta.faces.facelets" template="/WEB-INF/template.xhtml">

    <ui:define name="content">
        <h1 style="margin-bottom: 5px;"><i class="pi pi-eye" style="color: #8b5cf6;"></i> Seguimiento de Pedidos</h1>
        <p style="color: #666; margin-top: 0;">Consulta el estado y detalle de todos tus requerimientos</p>

        <h:form id="formSeguimiento">
            <!-- Filtros -->
            <p:panel styleClass="shadow-2" style="margin-bottom: 20px;">
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <div>
                        <label style="font-weight: 500; margin-right: 8px;">Estado:</label>
                        <p:selectOneMenu value="#{seguimientoBean.filtroEstado}" style="width: 180px;">
                            <f:selectItem itemLabel="-- Todos --" itemValue="" />
                            <f:selectItem itemLabel="Pendiente" itemValue="PENDIENTE" />
                            <f:selectItem itemLabel="Observado" itemValue="OBSERVADO" />
                            <f:selectItem itemLabel="Aprobado" itemValue="APROBADO" />
                            <f:selectItem itemLabel="En Atención" itemValue="EN_ATENCION" />
                            <f:selectItem itemLabel="Atendido Total" itemValue="ATENDIDO_TOTAL" />
                            <f:selectItem itemLabel="Rechazado" itemValue="RECHAZADO" />
                        </p:selectOneMenu>
                    </div>
                    <p:commandButton value="Filtrar" icon="pi pi-filter" actionListener="#{seguimientoBean.filtrar}"
                        update="tablaPedidos" styleClass="ui-button-info" />
                    <p:commandButton value="Limpiar" icon="pi pi-times"
                        actionListener="#{seguimientoBean.limpiarFiltros}" update=":formSeguimiento"
                        styleClass="ui-button-secondary" />
                </div>
            </p:panel>

            <!-- Tabla con Row Expansion -->
            <p:dataTable id="tablaPedidos" value="#{seguimientoBean.requerimientos}" var="r" rowKey="#{r.id}"
                paginator="true" rows="10" stripedRows="true" rowExpandMode="single"
                emptyMessage="No se encontraron requerimientos" styleClass="shadow-2">

                <f:facet name="header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600;">Mis Requerimientos</span>
                        <p:badge value="#{seguimientoBean.requerimientos.size()}" severity="info" />
                    </div>
                </f:facet>

                <p:column style="width: 50px;">
                    <p:rowToggler />
                </p:column>

                <p:column headerText="ID" width="60" sortBy="#{r.id}">
                    <h:outputText value="#{r.id}" style="font-weight: bold; color: #3b82f6;" />
                </p:column>

                <p:column headerText="Fecha" width="100" sortBy="#{r.fechaSolicitud}">
                    <h:outputText value="#{r.fechaSolicitud}">
                        <f:convertDateTime pattern="dd/MM/yyyy" type="localDate" />
                    </h:outputText>
                </p:column>

                <p:column headerText="Área" width="60">
                    <p:badge value="#{r.areaNegocio.prefijo}" severity="info" rendered="#{r.areaNegocio ne null}" />
                </p:column>

                <p:column headerText="Proyecto" sortBy="#{r.proyecto.nombre}">
                    <h:outputText value="#{r.proyecto.nombre}" />
                </p:column>

                <p:column headerText="Jefe Aprobador">
                    <h:outputText value="#{r.jefeAprobador.nombreCompleto}" rendered="#{r.jefeAprobador ne null}" />
                </p:column>

                <p:column headerText="Etapa" width="70" style="text-align: center;">
                    <p:badge value="E#{r.etapa}" />
                </p:column>

                <p:column headerText="Items" width="70" style="text-align: center;">
                    <p:badge value="#{r.detalles.size()}" severity="warning" />
                </p:column>

                <p:column headerText="Estado" width="130">
                    <p:badge value="#{r.estado.label}" severity="#{r.estado eq 'APROBADO' ? 'success' : 
                                   (r.estado eq 'RECHAZADO' ? 'danger' : 
                                   (r.estado eq 'OBSERVADO' ? 'warning' : 
                                   (r.estado eq 'ATENDIDO_TOTAL' ? 'success' : 'info')))}" />
                </p:column>

                <!-- Row Expansion: Detalle de Items -->
                <p:rowExpansion>
                    <div style="padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #334155;">
                                    <i class="pi pi-info-circle"></i> Información General
                                </h4>
                                <table style="width: 100%; font-size: 0.9em;">
                                    <tr>
                                        <td style="padding: 4px 0; color: #64748b;">Código:</td>
                                        <td style="padding: 4px 0; font-weight: 600;">REQ-#{r.id}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px 0; color: #64748b;">Solicitante:</td>
                                        <td style="padding: 4px 0;">#{r.usuarioSolicitante.nombreCompleto}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px 0; color: #64748b;">Centro Costo:</td>
                                        <td style="padding: 4px 0;">#{r.centroCosto.codigo} - #{r.centroCosto.nombre}
                                        </td>
                                    </tr>
                                    <tr rendered="#{r.observacion ne null and r.observacion ne ''}">
                                        <td style="padding: 4px 0; color: #64748b;">Observación:</td>
                                        <td style="padding: 4px 0; color: #f59e0b;">#{r.observacion}</td>
                                    </tr>
                                </table>
                            </div>
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #334155;">
                                    <i class="pi pi-chart-line"></i> Estado de Atención
                                </h4>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <div style="flex: 1; background: #e2e8f0; height: 8px; border-radius: 4px;">
                                        <div style="background: #{r.estado eq 'ATENDIDO_TOTAL' ? '#22c55e' : '#3b82f6'}; 
                                            height: 100%; border-radius: 4px; 
                                            width: #{r.estado eq 'ATENDIDO_TOTAL' ? '100%' : 
                                                    (r.estado eq 'EN_ATENCION' ? '60%' : 
                                                    (r.estado eq 'APROBADO' ? '40%' : '20%'))};"></div>
                                    </div>
                                    <span style="font-size: 0.85em; color: #64748b;">
                                        #{r.estado eq 'ATENDIDO_TOTAL' ? '100%' :
                                        (r.estado eq 'EN_ATENCION' ? '~60%' :
                                        (r.estado eq 'APROBADO' ? 'Listo para compra' : 'En proceso'))}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <h4 style="margin: 15px 0 10px 0; color: #334155;">
                            <i class="pi pi-list"></i> Detalle de Items (#{r.detalles.size()})
                        </h4>
                        <p:dataTable value="#{r.detalles}" var="d" size="small" stripedRows="true"
                            style="border: 1px solid #e2e8f0; border-radius: 6px;">
                            <p:column headerText="#" width="40">
                                <h:outputText value="#{d_rowIndex + 1}" />
                            </p:column>
                            <p:column headerText="Material">
                                <h:outputText value="#{d.material.nombre}" style="font-weight: 500;" />
                            </p:column>
                            <p:column headerText="Grupo" width="120">
                                <h:outputText value="#{d.material.grupo.nombre}" />
                            </p:column>
                            <p:column headerText="Unidad" width="80">
                                <h:outputText value="#{d.material.unidad.abreviatura}" />
                            </p:column>
                            <p:column headerText="Solicitado" width="100" style="text-align: right;">
                                <h:outputText value="#{d.cantidadSolicitada}">
                                    <f:convertNumber minFractionDigits="2" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Atendido" width="100" style="text-align: right;">
                                <h:outputText value="#{d.cantidadAtendida ne null ? d.cantidadAtendida : 0}">
                                    <f:convertNumber minFractionDigits="2" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Pendiente" width="100" style="text-align: right; font-weight: bold;">
                                <h:outputText value="#{d.cantidadPendiente}"
                                    style="color: #{d.cantidadPendiente.compareTo(0) gt 0 ? '#dc2626' : '#22c55e'};">
                                    <f:convertNumber minFractionDigits="2" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="% Atención" width="100" style="text-align: center;">
                                <p:progressBar value="#{d.cantidadAtendida ne null ? 
                                    (d.cantidadAtendida.doubleValue() / d.cantidadSolicitada.doubleValue() * 100) : 0}"
                                    displayOnly="true" style="height: 10px;" />
                            </p:column>
                        </p:dataTable>
                    </div>
                </p:rowExpansion>
            </p:dataTable>
        </h:form>

        <style>
            .shadow-2 {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
        </style>
    </ui:define>
</ui:composition>